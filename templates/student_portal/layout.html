{% extends 'base.html' %}
{% load static custom_filters %}

{% block extra_css %}
<style>
    /* Modern Mobile-First Styles */
    body {
        background-color: #f0f2f5;
        padding-bottom: 80px; /* Space for bottom nav */
        font-family: 'Outfit', sans-serif; /* Example modern font */
    }
    
    .student-header {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px); /* Safari */
        padding: 0.8rem 1.2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 1000;
        border-bottom: 1px solid rgba(0,0,0,0.02);
        border-radius: 0 0 20px 20px;
        transition: all 0.3s ease;
    }
    
    .logo-container img {
        transition: transform 0.3s ease;
    }
    .logo-container:hover img {
        transform: scale(1.05);
    }

    .header-actions .btn-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        color: #333;
        transition: all 0.2s ease;
        position: relative;
        text-decoration: none;
    }
    
    .header-actions .btn-icon:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }
    
    .alert-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 18px;
        height: 18px;
        background: #ff3e1d;
        color: white;
        border-radius: 50%;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
    }

    .page-content {
        padding: 1.5rem 1rem;
        max-width: 800px; /* readable width */
        margin: 0 auto;
    }
    
    .wrapper {
        min-height: 100vh;
    }

    /* Dark Mode Support (Basic) */
    html.dark-theme body {
        background-color: #151515;
        color: #e0e0e0;
    }
    html.dark-theme .student-header {
        background: rgba(30, 30, 30, 0.9);
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    html.dark-theme .header-actions .btn-icon {
        background: #2d2d2d;
        color: #fff;
    }
    html.dark-theme h5 {
        color: #e0e0e0 !important;
    }
</style>
{% endblock %}

{% block body_content %}
<div class="wrapper">
    <!-- Modern Header -->
    <header class="student-header d-flex justify-content-between align-items-center">
        <!-- Logo & Brand -->
        <div class="d-flex align-items-center logo-container">
            {% if request.tenant.logo %}
                <img src="{{ request.tenant.logo.url }}" alt="Logo" width="42" height="42" class="rounded-circle me-3 shadow-sm">
            {% else %}
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3 shadow-sm" style="width: 42px; height: 42px; font-weight: bold; font-size: 1.2rem;">
                    {{ request.tenant.name|slice:":1"|default:"S" }}
                </div>
            {% endif %}
            <div>
                <h5 class="mb-0 fw-bold text-dark" style="font-size: 1.1rem; letter-spacing: -0.5px;">{{ request.tenant.name|default:"Student Portal" }}</h5>
                <small class="text-muted" style="font-size: 0.75rem;">Student Dashboard</small>
            </div>
        </div>

        <!-- Actions -->
        <div class="d-flex align-items-center gap-2 header-actions">
            
            <!-- Dark/Light Toggle -->
            <a href="javascript:;" class="btn-icon" id="themeToggle" onclick="toggleTheme()">
                <i class='bx bx-moon'></i>
            </a>

            <!-- Notification Bell -->
            <a href="javascript:;" class="btn-icon" data-bs-toggle="dropdown">
                <i class='bx bx-bell'></i>
                <span class="alert-badge d-none" id="notification-badge">0</span>
            </a>
            <!-- Simple Dropdown for Notifications (Static for now, populated by JS ideally) -->
            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-0" style="width: 300px; overflow: hidden; border-radius: 12px;">
                <li class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Notifications</h6>
                    <small class="text-primary cursor-pointer">Mark all read</small>
                </li>
                <div id="notification-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- JS will populate -->
                    <li class="text-center p-4 text-muted small empty-state">No new notifications</li>
                </div>
                <li class="border-top p-2 text-center">
                    <a href="#" class="text-decoration-none small text-secondary">View All</a>
                </li>
            </ul>

            <!-- Profile Dropdown -->
            <div class="dropdown ms-1">
                 <a class="d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    {% if request.user.profile_picture %}
                         <img src="{{ request.user.profile_picture.url }}" class="rounded-circle shadow-sm border border-2 border-white" alt="user" width="42" height="42" style="object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle bg-soft-primary text-primary d-flex align-items-center justify-content-center border border-2 border-white shadow-sm" style="width: 42px; height: 42px;">
                            <i class="bx bx-user fs-5"></i>
                        </div>
                    {% endif %}
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" style="border-radius: 12px; margin-top: 10px;">
                    <li class="px-3 py-2 border-bottom mb-2">
                        <div class="fw-bold">{{ request.user.get_full_name }}</div>
                        <div class="small text-muted text-truncate" style="max-width: 150px;">{{ request.user.email }}</div>
                    </li>
                    <li><a class="dropdown-item py-2" href="{% url 'student_portal:profile' %}"><i class="bx bx-user me-2"></i>My Profile</a></li>
                    <li><a class="dropdown-item py-2" href="{% url 'student_portal:invoice_list' %}"><i class="bx bx-credit-card me-2"></i>Billing</a></li>
                    <li><div class="dropdown-divider"></div></li>
                    <li><a class="dropdown-item py-2 text-danger" href="{% url 'logout' %}"><i class='bx bx-log-out-circle me-2'></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="page-content">
        <!-- Alerts -->
        {% include "partials/alert.html" %}
        
        {% block content %}
        {% endblock %}
    </div>

    <!-- Bottom Navigation -->
    {% include 'student_portal/partials/bottom_nav.html' %}
    
</div>

<!-- Misc Scripts -->
{% include 'partials/theme_switcher.html' %}

<script>
    // Theme Toggle Logic
    function toggleTheme() {
        const html = document.documentElement;
        const icon = document.querySelector('#themeToggle i');
        
        if (html.classList.contains('dark-theme')) {
            html.classList.remove('dark-theme');
            html.classList.add('light-theme');
            icon.className = 'bx bx-moon';
            localStorage.setItem('theme', 'light');
        } else {
            html.classList.add('dark-theme');
            html.classList.remove('light-theme');
            icon.className = 'bx bx-sun';
            localStorage.setItem('theme', 'dark');
        }
    }
    
    // Init Theme
    if(localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark-theme');
        document.querySelector('#themeToggle i').className = 'bx bx-sun';
    }

    // WebSocket Notification
    document.addEventListener("DOMContentLoaded", function() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socketUrl = protocol + '//' + window.location.host + '/ws/notifications/';
        
        console.log("Connecting to WebSocket:", socketUrl);
        
        let socket = new WebSocket(socketUrl);
        let unreadCount = 0;

        socket.onopen = function(e) { console.log("WebSocket connected"); };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // 1. Show Toast
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info alert-dismissible fade show fixed-top m-3 shadow-lg border-0';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.background = 'rgba(255, 255, 255, 0.95)';
            alertDiv.style.backdropFilter = 'blur(10px)';
            alertDiv.style.borderLeft = '4px solid #0d6efd';
            
            alertDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="bg-light rounded-circle p-2 me-3 text-primary"><i class="bx bx-bell fs-4"></i></div>
                    <div>
                        <strong class="d-block mb-1 text-dark">${data.title}</strong>
                        <span class="text-secondary small">${data.message}</span>
                    </div>
                </div>
                ${data.action_url ? `<a href="${data.action_url}" class="stretched-link"></a>` : ''}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto dismiss
            setTimeout(() => { alertDiv.remove(); }, 5000);

            // 2. Update Badge
            unreadCount++;
            const badge = document.getElementById('notification-badge');
            badge.innerText = unreadCount;
            badge.classList.remove('d-none');
            
            // 3. Add to dropdown
            const list = document.getElementById('notification-list');
            const emptyState = list.querySelector('.empty-state');
            if(emptyState) emptyState.remove();
            
            const newItem = document.createElement('li');
            newItem.className = 'dropdown-item p-3 border-bottom bg-light';
            newItem.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="msg-name mb-0 small fw-bold">${data.title}</h6>
                        <p class="msg-info mb-0 small text-muted text-truncate">${data.message}</p>
                    </div>
                </div>
            `;
            list.insertBefore(newItem, list.firstChild);
        };
    });
</script>
{% endblock %}
