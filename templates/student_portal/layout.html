{% extends 'base.html' %}
{% load static custom_filters %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_dashboard.css' %}">
{% endblock %}

{% block body_content %}
<div class="wrapper">
    <!-- Modern Header -->
    {% include 'student_portal/partials/header.html' %}
    <!-- Main Content -->
    <div class="page-content">
        <!-- Alerts -->
        {% include "partials/alert.html" %}
        
        {% block content %}
        {% endblock %}
    </div>

    <!-- Bottom Navigation -->
    {% include 'student_portal/partials/bottom_nav.html' %}
    
</div>

<!-- Misc Scripts -->
{% include 'partials/theme_switcher.html' %}

<script>
    // Theme Toggle Logic
    function toggleTheme() {
        const html = document.documentElement;
        const icon = document.querySelector('#themeToggle i');
        
        if (html.classList.contains('dark-theme')) {
            html.classList.remove('dark-theme');
            html.classList.add('light-theme');
            icon.className = 'bx bx-moon';
            localStorage.setItem('theme', 'light');
        } else {
            html.classList.add('dark-theme');
            html.classList.remove('light-theme');
            icon.className = 'bx bx-sun';
            localStorage.setItem('theme', 'dark');
        }
    }
    
    // Init Theme
    if(localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark-theme');
        document.querySelector('#themeToggle i').className = 'bx bx-sun';
    }

    // WebSocket Notification
    document.addEventListener("DOMContentLoaded", function() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socketUrl = protocol + '//' + window.location.host + '/ws/notifications/';
        
        console.log("Connecting to WebSocket:", socketUrl);
        
        let socket = new WebSocket(socketUrl);
        let unreadCount = 0;

        socket.onopen = function(e) { console.log("WebSocket connected"); };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // 1. Show Toast
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info alert-dismissible fade show fixed-top m-3 shadow-lg border-0';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.background = 'rgba(255, 255, 255, 0.95)';
            alertDiv.style.backdropFilter = 'blur(10px)';
            alertDiv.style.borderLeft = '4px solid #0d6efd';
            
            alertDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="bg-light rounded-circle p-2 me-3 text-primary"><i class="bx bx-bell fs-4"></i></div>
                    <div>
                        <strong class="d-block mb-1 text-dark">${data.title}</strong>
                        <span class="text-secondary small">${data.message}</span>
                    </div>
                </div>
                ${data.action_url ? `<a href="${data.action_url}" class="stretched-link"></a>` : ''}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto dismiss
            setTimeout(() => { alertDiv.remove(); }, 5000);

            // 2. Update Badge
            unreadCount++;
            const badge = document.getElementById('notification-badge');
            badge.innerText = unreadCount;
            badge.classList.remove('d-none');
            
            // 3. Add to dropdown
            const list = document.getElementById('notification-list');
            const emptyState = list.querySelector('.empty-state');
            if(emptyState) emptyState.remove();
            
            const newItem = document.createElement('li');
            newItem.className = 'dropdown-item p-3 border-bottom bg-light';
            newItem.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="msg-name mb-0 small fw-bold">${data.title}</h6>
                        <p class="msg-info mb-0 small text-muted text-truncate">${data.message}</p>
                    </div>
                </div>
            `;
            list.insertBefore(newItem, list.firstChild);
        };
    });
</script>
{% endblock %}
