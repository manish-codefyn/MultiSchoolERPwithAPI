<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

  
    <!--plugins-->
    <link href="{% static 'assets/plugins/notifications/css/lobibox.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'assets/plugins/vectormap/jquery-jvectormap-2.0.2.css' %}" rel="stylesheet"/>
    <link href="{% static 'assets/plugins/simplebar/css/simplebar.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/plugins/metismenu/css/metisMenu.min.css' %}" rel="stylesheet" />

    <!-- loader -->
    <link href="{% static 'assets/css/pace.min.css' %}" rel="stylesheet"/>
    <script src="{% static 'assets/js/pace.min.js' %}"></script>

    <!-- Bootstrap CSS -->
    <link href="{% static 'assets/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'assets/css/bootstrap-extended.css' %}" rel="stylesheet">

    <!-- Google Font (keep external, no static required) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <link href="{% static 'assets/css/app.css' %}" rel="stylesheet">
    <link href="{% static 'assets/css/icons.css' %}" rel="stylesheet">
    {% load compress %}
    {% compress css %}

    <!-- Theme Style CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/dark-theme.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/semi-dark.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/header-colors.css' %}" />


    <!-- Page Specific CSS -->
    {% endcompress %}
    {% block extra_css %}{% endblock %}
    <!-- Dynamic Title -->
    <title>{% block title %}{{ site_title|default:tenant.name }} â€” codefyn {% endblock %}</title>

    <!-- Dynamic Meta Tags -->
    <meta name="description" content="{{ site_description }}">
    <meta name="keywords" content="{{ site_keywords }}">
    <meta name="author" content="{{ meta_author }}">
    
    <!-- Dynamic Favicon -->
    {% if tenant.favicon %}
        <link rel="icon" href="{{ tenant.favicon.url }}" type="image/x-icon">
        <link rel="apple-touch-icon" href="{{ tenant.favicon.url }}">
    {% else %}
        <link rel="icon" href="{% static 'images/favicon/favicon.ico' %}" type="image/x-icon">
    {% endif %}
</head>

<body>
	<!--wrapper-->
	<div class="wrapper">
      
	    {% block body_content %}
      <!-- Default body content - can be overridden by layouts -->
        {% endblock %}
		<!--end page wrapper -->
		<!--start overlay-->
		<div class="overlay toggle-icon"></div>
		<!--end overlay-->
		<!--Start Back To Top Button-->
         <a href="javaScript:;" class="back-to-top"><i class='bx bxs-up-arrow-alt'></i></a>
		<!--End Back To Top Button-->
        <!-- Footer -->
       <!-- {% include "partials/footer.html" %} -->

    </div>
	<!--end wrapper-->

	<!--start switcher-->


	<!--end switcher-->
    <!-- Bootstrap JS -->
    <script src="{% static 'assets/js/bootstrap.bundle.min.js' %}"></script>
    <!-- Plugins -->
    <script src="{% static 'assets/js/jquery.min.js' %}"></script>
    <script src="{% static 'assets/plugins/simplebar/js/simplebar.min.js' %}"></script>
    <script src="{% static 'assets/plugins/metismenu/js/metisMenu.min.js' %}"></script>
    <script src="{% static 'assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js' %}"></script>
    <script src="{% static 'assets/plugins/vectormap/jquery-jvectormap-2.0.2.min.js' %}"></script>
    <script src="{% static 'assets/plugins/vectormap/jquery-jvectormap-world-mill-en.js' %}"></script>
    <script src="{% static 'assets/plugins/chartjs/js/chart.js' %}"></script>
    <script src="{% static 'assets/plugins/chartjs/js/Chart.extension.js' %}"></script>
    <script src="{% static 'assets/plugins/sparkline-charts/jquery.sparkline.min.js' %}"></script>
    <!-- Notification JS -->
    <script src="{% static 'assets/plugins/notifications/js/lobibox.min.js' %}"></script>
    <script src="{% static 'assets/plugins/notifications/js/notifications.min.js' %}"></script>
    {% load compress %}
    {% compress js %}
    <script src="{% static 'assets/js/index3.js' %}"></script>
    <script src="{% static 'assets/js/app.js' %}"></script>
    {% endcompress %}
    <!-- Page Specific JS -->
    {% block extra_scripts %}{% endblock %}
    {% block extra_js %}{% endblock %}

    {% if user.is_authenticated %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = protocol + window.location.host + '/ws/notifications/';
            
            console.log('Connecting to WebSocket:', wsUrl);
            
            const socket = new WebSocket(wsUrl);

            socket.onopen = function(e) {
                console.log('WebSocket connected');
            };

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Notification received:', data);
                
                if (data.type === 'notification' || data.type === 'notification_message') {
                    // Use Lobibox if available, else standard alert or console
                    if (typeof Lobibox !== 'undefined') {
                        Lobibox.notify('info', {
                            pauseDelayOnHover: true,
                            continueDelayOnInactiveTab: false,
                            position: 'top right',
                            icon: 'bx bx-message-square-detail',
                            msg: data.message,
                            title: data.title,
                            img: data.img || null,
                             onClick: function() {
                                if (data.action_url && data.action_url !== '#') {
                                    window.location.href = data.action_url;
                                }
                            }
                        });
                    }
                } else if (data.type === 'chat_message') {
                    // Dispatch event for active chat windows
                    const event = new CustomEvent('chat_message_received', { detail: data });
                    document.dispatchEvent(event);
                    
                    // Show notification if we are NOT on the thread page for this message
                    // Simple check: check URL
                    const currentPath = window.location.pathname;
                    const threadPath = `/communications/inbox/${data.thread_id}/`;
                    
                    if (!currentPath.includes(threadPath)) {
                         if (typeof Lobibox !== 'undefined') {
                            Lobibox.notify('default', {
                                pauseDelayOnHover: true,
                                continueDelayOnInactiveTab: false,
                                position: 'top right',
                                icon: 'bx bx-chat',
                                msg: data.message,
                                title: data.title,
                                onClick: function() {
                                    if (data.action_url) {
                                        window.location.href = data.action_url;
                                    }
                                }
                            });
                        }
                    }
                }
            };

            socket.onclose = function(e) {
                console.error('WebSocket closed unexpectedly');
            };
        });
    </script>
    {% endif %}
</body>
</html>