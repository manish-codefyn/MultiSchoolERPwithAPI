{% extends 'layouts/dashboard.html' %}
{% load static crispy_forms_tags %}
{% load i18n %}

{% block page_title %}
    {% if object %}{% trans "Edit Timetable Entry" %}{% else %}{% trans "Add Timetable Entry" %}{% endif %}
{% endblock %}

{% block content %}
{% url 'academics:timetable_list' as list_url %}
{% if object %}
    {% trans "Edit Timetable Entry" as p_title %}
    {% trans "Edit" as c_text %}
{% else %}
    {% trans "New Timetable Entry" as p_title %}
    {% trans "Create" as c_text %}
{% endif %}

{% include 'partials/breadcrumb.html' with page_title=p_title parent_text=_("Timetable") parent_url=list_url current_text=c_text action_url=list_url action_text=_("Back") %}

<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">
                    {{ p_title }}
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.academic_year|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                             <!-- Placeholder for visual balance -->
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.class_name|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.section|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.day|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.period_number|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.start_time|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.end_time|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row">
                         <div class="col-md-6 mb-3">
                            {{ form.period_type|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                             {{ form.room|as_crispy_field }}
                        </div>
                    </div>

                     <div class="row">
                         <div class="col-md-6 mb-3">
                            {{ form.subject|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3">
                             {{ form.teacher|as_crispy_field }}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="{% url 'academics:timetable_list' %}" class="btn btn-secondary">
                            {% trans "Cancel" %}
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bx bx-save"></i> {% trans "Save" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}
<link href="{% static 'assets/plugins/select2/css/select2.min.css' %}" rel="stylesheet" />
<link href="{% static 'assets/plugins/select2/css/select2-bootstrap4.css' %}" rel="stylesheet" />
<script src="{% static 'assets/plugins/select2/js/select2.min.js' %}"></script>

<script>
    $(document).ready(function() {
        // Initialize Select2
        $('.single-select').select2({
            theme: 'bootstrap4',
            width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
            placeholder: $(this).data('placeholder'),
            allowClear: Boolean($(this).data('allow-clear')),
        });

        // Add class to select fields to enable initialization if not already done via class
        $('#id_class_name, #id_section, #id_subject, #id_teacher, #id_academic_year').select2({
            theme: 'bootstrap4',
            width: '100%'
        });

        const classSelect = $('#id_class_name');
        const sectionSelect = $('#id_section');
        const subjectSelect = $('#id_subject');

        function loadDependentData(classId) {
            if (!classId) {
                sectionSelect.html('<option value="">---------</option>').trigger('change');
                subjectSelect.html('<option value="">---------</option>').trigger('change');
                return;
            }

            // Load Sections
            $.ajax({
                url: "{% url 'academics:ajax_load_sections' %}",
                data: {
                    'class_id': classId
                },
                success: function(data) {
                    let sectionHtml = '<option value="">---------</option>';
                    data.forEach(function(section) {
                        const selected = (section.id == sectionSelect.attr('data-selected')) ? 'selected' : '';
                        sectionHtml += `<option value="${section.id}" ${selected}>${section.name}</option>`;
                    });
                    sectionSelect.html(sectionHtml).trigger('change');
                }
            });

            // Load Subjects
            $.ajax({
                url: "{% url 'academics:ajax_load_subjects' %}",
                data: {
                    'class_id': classId
                },
                success: function(data) {
                    let subjectHtml = '<option value="">---------</option>';
                    if (data.length === 0) {
                        subjectHtml = '<option value="">{% trans "No subjects assigned to this class!" %}</option>';
                    } else {
                        data.forEach(function(item) {
                            subjectHtml += `<option value="${item.id}">${item.subject__name}</option>`;
                        });
                    }
                    subjectSelect.html(subjectHtml).trigger('change');
                },
                error: function(xhr, status, error) {
                     console.error("Error loading subjects:", error);
                     subjectSelect.html('<option value="">{% trans "Error loading subjects" %}</option>').trigger('change');
                }
            });
        }

        classSelect.change(function() {
            loadDependentData($(this).val());
        });
        
        // Initial load if class is selected (e.g. edit mode)
        if (classSelect.val()) {
             // We don't want to wipe out existing selections on page load in edit mode
             // unless we specifically need to refresh. 
             // Ideally, the form renders with correct initial options.
             // So we might NOT want to call loadDependentData() immediately on edit 
             // IF the form fields are already populated by Django. 
             // But for 'create' mode with just class pre-selected, we might.
             // Let's assume Django populates the form correctly for Edit.
        }
    });
</script>
{% endblock %}
