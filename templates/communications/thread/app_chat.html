{% extends 'layouts/dashboard.html' %}
{% load static i18n %}

{% block content %}
<div class="chat-wrapper">
    <div class="chat-sidebar">
        <div class="chat-sidebar-header">
            <div class="d-flex align-items-center">
                <div class="chat-user-online">
                    {% if request.user.avatar %}
                    <img src="{{ request.user.avatar.url }}" width="45" height="45" class="rounded-circle" alt="" />
                    {% else %}
                    <img src="{% static 'assets/images/avatars/avatar-1.png' %}" width="45" height="45" class="rounded-circle" alt="" />
                    {% endif %}
                </div>
                <div class="flex-grow-1 ms-2">
                    <p class="mb-0">{{ request.user.get_full_name }}</p>
                </div>
                <div class="dropdown">
                    <div class="cursor-pointer font-24 dropdown-toggle dropdown-toggle-nocaret" data-bs-toggle="dropdown"><i class='bx bx-dots-horizontal-rounded'></i>
                    </div>
                    <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="{% url 'communications:communication_create' %}">New Conversation</a>
                    </div>
                </div>
            </div>
            <div class="mb-3"></div>
            <div class="input-group input-group-sm"> <span class="input-group-text bg-transparent"><i class='bx bx-search'></i></span>
                <input type="text" class="form-control" placeholder="Search chats..."> 
            </div>
        </div>
        <div class="chat-sidebar-content">
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-Chats">
                    <div class="chat-list">
                        <div class="list-group list-group-flush">
                            {% for item in threads %}
                            <a href="{% url 'communications:thread_detail' item.id %}" class="list-group-item {% if thread.id == item.id %}active{% endif %}">
                                <div class="d-flex">
                                    <div class="chat-user-online">
                                        {# Use first other participant's avatar or default #}
                                        <img src="{% static 'assets/images/avatars/avatar-2.png' %}" width="42" height="42" class="rounded-circle" alt="" />
                                    </div>
                                    <div class="flex-grow-1 ms-2">
                                        <h6 class="mb-0 chat-title">{{ item.title|truncatechars:20 }}</h6>
                                        <p class="mb-0 chat-msg">{{ item.last_message_at|timesince }} ago</p>
                                    </div>
                                    <div class="chat-time">
                                        {% if item.unread_count > 0 %}<span class="badge bg-danger rounded-pill">{{ item.unread_count }}</span>{% endif %}
                                    </div>
                                </div>
                            </a>
                            {% empty %}
                            <div class="p-3 text-center">
                                <p>No conversations yet.</p>
                                <a href="{% url 'communications:communication_create' %}" class="btn btn-primary btn-sm">Start New</a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="chat-header d-flex align-items-center">
        <div class="chat-toggle-btn"><i class='bx bx-menu-alt-left'></i>
        </div>
        {% if thread %}
        <div>
            <h4 class="mb-1 font-weight-bold">{{ thread.title }}</h4>
            <div class="list-inline d-sm-flex mb-0 d-none text-secondary">
                <small class="list-inline-item">
                    {% for p in thread.participants.all %}{{ p.get_full_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                </small>
            </div>
        </div>
        {% else %}
        <div>
            <h4 class="mb-1 font-weight-bold">Select a conversation</h4>
        </div>
        {% endif %}
    </div>

    <div class="chat-content" id="chat-messages">
        {% if thread %}
            {% for message in thread.messages.all %}
                {% if message.sender == request.user %}
                <div class="chat-content-rightside">
                    <div class="d-flex ms-auto">
                        <div class="flex-grow-1 me-2">
                            <p class="mb-0 chat-time text-end">You, {{ message.created_at|date:"g:i A" }}</p>
                            <p class="chat-right-msg">{{ message.body|linebreaksbr }}</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="chat-content-leftside">
                    <div class="d-flex">
                        {% if message.sender.avatar %}
                        <img src="{{ message.sender.avatar.url }}" width="48" height="48" class="rounded-circle" alt="" />
                        {% else %}
                        <img src="{% static 'assets/images/avatars/avatar-3.png' %}" width="48" height="48" class="rounded-circle" alt="" />
                        {% endif %}
                        <div class="flex-grow-1 ms-2">
                            <p class="mb-0 chat-time">{{ message.sender.get_full_name }}, {{ message.created_at|date:"g:i A" }}</p>
                            <p class="chat-left-msg">{{ message.body|linebreaksbr }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% empty %}
            <div class="text-center py-5">
                <p class="text-muted">No messages yet.</p>
            </div>
            {% endfor %}
        {% else %}
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="text-center">
                <i class='bx bx-message-square-dots fs-1 text-muted'></i>
                <p class="mt-3 text-muted">Select a conversation from the sidebar to start chatting.</p>
            </div>
        </div>
        {% endif %}
    </div>

    {% if thread %}
    <div class="chat-footer d-flex align-items-center">
        <div class="flex-grow-1 pe-2">
            <form action="{% url 'communications:thread_reply' thread.id %}" method="post" id="reply-form">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" name="body" class="form-control" placeholder="Type a message..." required>
                    <button type="submit" class="btn btn-primary"><i class='bx bx-send'></i></button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!--start chat overlay-->
    <div class="overlay chat-toggle-btn-mobile"></div>
    <!--end chat overlay-->
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize scrolling
    const chatContainer = document.getElementById('chat-messages');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
        new PerfectScrollbar('.chat-sidebar-content');
        new PerfectScrollbar('.chat-content');
    }

    // Mobile toggle
    $('.chat-toggle-btn').on('click', function() {
		$('.chat-wrapper').toggleClass('chat-toggled conversation-start');
	});
	$('.chat-toggle-btn-mobile').on('click', function() {
		$('.chat-wrapper').removeClass('chat-toggled');
	});

    {% if thread %}
    // Listen for real-time messages
    document.addEventListener('chat_message_received', function(e) {
        const data = e.detail;
        const currentThreadId = "{{ thread.id }}";
        
        if (String(data.thread_id) === String(currentThreadId)) {
            const isMe = data.sender_id == "{{ request.user.id }}";
            let html = '';
            
            if (isMe) {
                 html = `
                <div class="chat-content-rightside">
                    <div class="d-flex ms-auto">
                        <div class="flex-grow-1 me-2">
                            <p class="mb-0 chat-time text-end">You, Just now</p>
                            <p class="chat-right-msg">${data.message}</p>
                        </div>
                    </div>
                </div>`;
            } else {
                html = `
                <div class="chat-content-leftside">
                    <div class="d-flex">
                        <img src="{% static 'assets/images/avatars/avatar-3.png' %}" width="48" height="48" class="rounded-circle" alt="" />
                        <div class="flex-grow-1 ms-2">
                            <p class="mb-0 chat-time">${data.sender_name}, Just now</p>
                            <p class="chat-left-msg">${data.message}</p>
                        </div>
                    </div>
                </div>`;
            }
            
            chatContainer.insertAdjacentHTML('beforeend', html);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    });
    {% endif %}
</script>
{% endblock %}
