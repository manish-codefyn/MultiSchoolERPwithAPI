{% extends 'layouts/dashboard.html' %}
{% load static %}

{% block title %}Students Dashboard - EduERP{% endblock %}

{% block content %}
<div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
    <div class="breadcrumb-title pe-3">Students</div>
    <div class="ps-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 p-0">
                <li class="breadcrumb-item"><a href="{% url 'dashboard_redirect' %}"><i class="bx bx-home-alt"></i></a></li>
                <li class="breadcrumb-item active" aria-current="page">Students Dashboard</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Header Stats -->
<div class="row row-cols-1 row-cols-md-2 row-cols-xl-4">
    <div class="col">
        <div class="card radius-10 border-start border-0 border-3 border-info">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <p class="mb-0 text-secondary">Total Students</p>
                        <h4 class="my-1 text-info">{{ total_students|default:"0" }}</h4>
                        <p class="mb-0 font-13 text-secondary">Across all classes</p>
                    </div>
                    <div class="widgets-icons-2 rounded-circle bg-gradient-scooter text-white ms-auto">
                        <i class='bx bxs-group'></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card radius-10 border-start border-0 border-3 border-success">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <p class="mb-0 text-secondary">Active Students</p>
                        <h4 class="my-1 text-success">{{ active_students|default:"0" }}</h4>
                        <p class="mb-0 font-13 text-secondary">Currently Enrolled</p>
                    </div>
                    <div class="widgets-icons-2 rounded-circle bg-gradient-ohhappiness text-white ms-auto">
                        <i class='bx bxs-user-check'></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card radius-10 border-start border-0 border-3 border-warning">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <p class="mb-0 text-secondary">Graduated</p>
                        <h4 class="my-1 text-warning">{{ graduated_students|default:"0" }}</h4>
                        <p class="mb-0 font-13 text-secondary">Alumni members</p>
                    </div>
                    <div class="widgets-icons-2 rounded-circle bg-gradient-orange text-white ms-auto">
                        <i class='bx bxs-graduation'></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card radius-10 border-start border-0 border-3 border-danger">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <p class="mb-0 text-secondary">Suspended</p>
                        <h4 class="my-1 text-danger">{{ suspended_students|default:"0" }}</h4>
                        <p class="mb-0 font-13 text-secondary">Action required</p>
                    </div>
                    <div class="widgets-icons-2 rounded-circle bg-gradient-bloody text-white ms-auto">
                        <i class='bx bxs-user-x'></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Access Shortcuts -->
<div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-xl-6 mb-4">
    {% for action in quick_actions %}
    <div class="col">
        <a href="{{ action.url }}" class="text-decoration-none">
            <div class="card radius-10 border-0 shadow-sm transition-hover">
                <div class="card-body p-3 text-center">
                    <div class="widgets-icons-2 rounded-circle bg-light-{{ action.color }} text-{{ action.color }} mb-2 mx-auto shadow-none">
                        <i class='bx bx-{{ action.icon }}'></i>
                    </div>
                    <h6 class="mb-0 text-dark font-weight-bold small">{{ action.name }}</h6>
                </div>
            </div>
        </a>
    </div>
    {% endfor %}
</div>

<style>
    .transition-hover {
        transition: all 0.3s cubic-bezier(.25,.8,.25,1);
    }
    .transition-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        background-color: #f8f9fa;
    }
    .bg-light-primary { background-color: rgba(13, 110, 253, 0.1); }
    .bg-light-success { background-color: rgba(25, 135, 84, 0.1); }
    .bg-light-info { background-color: rgba(13, 202, 240, 0.1); }
    .bg-light-warning { background-color: rgba(255, 193, 7, 0.1); }
    .bg-light-danger { background-color: rgba(220, 53, 69, 0.1); }
    .bg-light-secondary { background-color: rgba(108, 117, 125, 0.1); }
    
    .text-primary { color: #0d6efd !important; }
    .text-success { color: #198754 !important; }
    .text-info { color: #0dcaf0 !important; }
    .text-warning { color: #ffc107 !important; }
    .text-danger { color: #dc3545 !important; }
    .text-secondary { color: #6c757d !important; }
</style>

<div class="row">
    <!-- Progress Graph -->
    <div class="col-12 col-lg-8">
        <div class="card radius-10 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h6 class="mb-0 font-weight-bold"><i class="bx bx-trending-up me-2"></i>Student Enrollment Growth</h6>
            </div>
            <div class="card-body">
                <div id="studentGrowthChart" style="height: 350px;"></div>
            </div>
        </div>
    </div>

    <!-- Class Stats -->
    <div class="col-12 col-lg-4">
        <div class="card radius-10 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h6 class="mb-0 font-weight-bold">Class Distribution</h6>
            </div>
            <div class="card-body">
                {% for cls in class_stats %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small font-weight-bold">{{ cls.name }}</span>
                        <span class="small text-muted">{{ cls.count }} Students</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: {{ cls.percentage }}%"></div>
                    </div>
                </div>
                {% empty %}
                <p class="text-center text-muted my-4">No enrollment data available.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Report Center -->
<div class="row">
    <div class="col-12">
        <div class="card radius-10 shadow-sm border-0">
            <div class="card-header bg-transparent border-0">
                <div class="d-flex align-items-center">
                    <div>
                        <h6 class="mb-0 text-primary fw-bold"><i class="bx bx-file-find me-2"></i>Student Report Center</h6>
                        <small class="text-muted">Export filtered student progress and enrollment data</small>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form action="{% url 'students:student_export' %}" method="get" class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Academic Year</label>
                        <select name="academic_year" class="form-select form-select-sm">
                            <option value="">All Years</option>
                            {% for ay in academic_years %}
                            <option value="{{ ay.id }}">{{ ay.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Class</label>
                        <select name="class_id" class="form-select form-select-sm">
                            <option value="">All Classes</option>
                            {% for cls in classes %}
                            <option value="{{ cls.id }}">{{ cls.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label small fw-bold">Section</label>
                        <select name="section_id" class="form-select form-select-sm">
                            <option value="">All</option>
                            {% for sec in sections %}
                            <option value="{{ sec.id }}">{{ sec.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Month</label>
                        <select name="month" class="form-select form-select-sm">
                            <option value="">All Months</option>
                            {% for m_id, m_name in months %}
                            <option value="{{ m_id }}">{{ m_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label small fw-bold">Year</label>
                        <select name="year" class="form-select form-select-sm">
                            <option value="">All</option>
                            {% for y in years %}
                            <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Status</label>
                        <select name="status" class="form-select form-select-sm">
                            <option value="">All Statuses</option>
                            <option value="ACTIVE">Active</option>
                            <option value="INACTIVE">Inactive</option>
                            <option value="GRADUATED">Graduated</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="btn-group btn-group-sm w-100">
                            <button type="submit" name="format" value="pdf" class="btn btn-outline-danger"><i class="bx bxs-file-pdf"></i> PDF</button>
                            <button type="submit" name="format" value="excel" class="btn btn-outline-success"><i class="bx bxs-file-export"></i> Excel</button>
                            <button type="submit" name="format" value="csv" class="btn btn-outline-info"><i class="bx bx-file"></i> CSV</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ApexCharts Script -->
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
$(document).ready(function() {
    var options = {
        series: [{
            name: 'New Admissions',
            data: {{ growth_values|safe|default:"[]" }}
        }],
        chart: {
            type: 'area',
            height: 350,
            toolbar: { show: false },
            zoom: { enabled: false }
        },
        colors: ['#6078ea'],
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.1,
                stops: [0, 90, 100]
            }
        },
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 3 },
        xaxis: {
            categories: {{ growth_labels|safe|default:"[]" }},
        },
        tooltip: {
            theme: 'dark',
            x: { show: true }
        }
    };

    var chart = new ApexCharts(document.querySelector("#studentGrowthChart"), options);
    chart.render();
});
</script>
{% endblock %}

{% endblock %}
